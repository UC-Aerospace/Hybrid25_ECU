# ADS124S08 HAL Conversion for STM32

This document describes the conversion of the ADS124S08 Hardware Abstraction Layer (HAL) from TI Drivers to STM32 HAL.

## Overview

The ADS124S08 is a precision, 24-bit analog-to-digital converter (ADC) that communicates via SPI. The original code was designed for TI microcontrollers using TI Drivers. This conversion adapts it for STM32 microcontrollers using the STM32 HAL library.

## Changes Made

### 1. Header Files (`hal.h`)
- Replaced TI Drivers includes with STM32 HAL includes
- Updated pin definitions to match STM32G0 GPIO pins
- Converted function prototypes to use `SPI_HandleTypeDef*` instead of `SPI_Handle`

### 2. Implementation Files (`hal.c`)
- **Timing functions**: 
  - `delay_ms()`: Now uses `HAL_Delay()`
  - `delay_us()`: Implemented using cycle counting for microsecond precision
- **GPIO functions**: 
  - Converted to use `HAL_GPIO_WritePin()` and `HAL_GPIO_ReadPin()`
  - Updated interrupt handling to use STM32 EXTI callbacks
- **SPI functions**: 
  - Converted to use `HAL_SPI_TransmitReceive()`
  - Removed manual CS control (now handled by SPI peripheral)

### 3. ADS124 Driver (`ads124.c` and `ads124.h`)
- Updated all function signatures to use `SPI_HandleTypeDef*`
- Converted all SPI communication calls to use the new HAL functions

## Pin Mapping

The following STM32G0 pins are used for the ADS124S08 interface:

| ADS124S08 Signal | STM32G0 Pin | Description |
|------------------|-------------|-------------|
| nDRDY            | PC5 (ADC_RDY) | Data Ready interrupt (falling edge) |
| nRESET           | PB0 (ADC_RST) | Reset pin (active low) |
| START/SYNC       | PC4 (SYNC)    | Start/Sync pin |
| nCS              | PA4 (SPI1_NSS)| Chip Select (auto-controlled by SPI) |
| SCLK             | PA5 (SPI1_SCK)| SPI Clock |
| DIN              | PA7 (SPI1_MOSI)| SPI Master Out Slave In |
| DOUT             | PA6 (SPI1_MISO)| SPI Master In Slave Out |

## Usage Example

**IMPORTANT:** The `HAL_GPIO_EXTI_Callback` function MUST be implemented in your `main.c` file, not in the HAL library files. This is because it's a weak function in the STM32 HAL that needs to be overridden in your main application.

```c
#include "ads124_example.h"
#include "hal.h"  // For ads124_gpio_exti_callback

int main(void)
{
    // STM32 HAL initialization (generated by STM32CubeMX)
    HAL_Init();
    SystemClock_Config();
    MX_GPIO_Init();
    MX_SPI1_Init();
    
    // Initialize ADS124S08
    if (ads124_init() != HAL_OK) {
        Error_Handler();
    }
    
    // Start conversions
    ads124_start_conversion();
    
    // Main loop
    while (1) {
        int32_t adc_value;
        uint8_t status;
        
        if (ads124_read_conversion(&adc_value, &status) == HAL_OK) {
            // Process ADC value
            float voltage = (float)adc_value * 2.5f / 8388608.0f;
            // Do something with voltage...
        }
        
        HAL_Delay(100);
    }
}

// CRITICAL: This function MUST be in main.c to handle interrupts properly
void HAL_GPIO_EXTI_Callback(uint16_t GPIO_Pin)
{
    // Call the ADS124 interrupt handler
    ads124_gpio_exti_callback(GPIO_Pin);
    
    // Handle other GPIO interrupts if needed
    // if (GPIO_Pin == OTHER_PIN) { ... }
}
```

## STM32CubeMX Configuration

### SPI1 Configuration
- Mode: Full-Duplex Master
- Hardware NSS Signal: Output
- Clock Polarity: Low (CPOL = 0)
- Clock Phase: 2 Edge (CPHA = 1)
- Data Size: 8 Bits
- Baud Rate: 2 MHz (or as needed)

### GPIO Configuration
- PC5 (ADC_RDY): GPIO_EXTI5, Falling Edge, Pull-up
- PB0 (ADC_RST): GPIO_Output, High level
- PC4 (SYNC): GPIO_Output, Low level

### Interrupt Configuration
- Enable EXTI4_15_IRQn for the DRDY interrupt

## Important Notes

1. **SPI Mode**: The ADS124S08 requires SPI Mode 1 (CPOL=0, CPHA=1)
2. **Timing**: The microsecond delay function uses cycle counting and may need calibration for precise timing
3. **CRITICAL - Interrupts**: The `HAL_GPIO_EXTI_Callback` function MUST be implemented in your main.c file, not in the HAL library. This is because it's a weak function in STM32 HAL that needs to be overridden in the main application.
4. **CS Control**: Chip Select is handled automatically by the SPI peripheral in NSS Output mode
5. **Error Handling**: All SPI operations include error checking and call `Error_Handler()` on failure

### Interrupt Handler Implementation

The correct way to handle the ADS124S08 interrupt is:

1. **In your main.c file**, implement `HAL_GPIO_EXTI_Callback`:
```c
void HAL_GPIO_EXTI_Callback(uint16_t GPIO_Pin)
{
    ads124_gpio_exti_callback(GPIO_Pin);  // Call ADS124 handler
    // Handle other pins if needed
}
```

2. **Include the header**: `#include "hal.h"` in your main.c to access `ads124_gpio_exti_callback`

3. **Do NOT** define `HAL_GPIO_EXTI_Callback` in library files - it won't be called by the linker.

## Files Modified/Created

### Modified Files:
- `src/modules/ADS124/hal.h` - Updated for STM32 HAL
- `src/modules/ADS124/hal.c` - Converted to STM32 HAL implementation
- `src/modules/ADS124/ads124.h` - Updated function prototypes
- `src/modules/ADS124/ads124.c` - Updated function implementations

### New Files:
- `src/modules/ADS124/ads124_example.h` - Example usage header
- `src/modules/ADS124/ads124_example.c` - Example implementation

## Testing

To test the converted HAL:

1. Configure STM32CubeMX as described above
2. Include the ADS124 files in your project
3. Implement the example code in your main application
4. Verify SPI communication and ADC readings

## Future Improvements

1. Implement DWT-based microsecond timing for better precision
2. Add support for manual CS control if needed
3. Add comprehensive error handling and status reporting
4. Implement advanced ADS124S08 features (multiple channels, calibration, etc.)
